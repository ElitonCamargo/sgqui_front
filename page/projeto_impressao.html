<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Folha de Projeto</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            margin: 20px;
            color: #333;
            width: 794px;
            /* Largura da folha A4 em pixels */
            height: 1123px;
            /* Altura da folha A4 em pixels */
            margin: 0 auto;
            /* Centraliza a página */
            padding: 20px;
            /* Ajuste conforme necessário */
            box-sizing: border-box;
            /* Inclui padding e bordas na largura total */
        }

        h1,
        h2,
        h3 {
            color: #006E00;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }

        th,
        td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        .section {
            margin-bottom: 30px;
        }

        .progress-bar-container {
            width: 100%;
            position: relative;
            height: 24px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f2f2f2;
            overflow: hidden;
        }

        .progress-bar-container {
            width: 100%;
            position: relative;
            height: 24px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f2f2f2;
            overflow: hidden;
            /* Adiciona overflow para garantir que a label fique visível */
        }

        .progress-bar {
            width: 100%;
            height: 100%;
            position: relative;
            background-color: #e0e0e0;
            /* Cor da parte restante */
        }

        .progress-completed {
            height: 100%;
            background-color: #006E00;
            /* Cor da parte concluída */
            width: 0;
            /* Largura será definida dinamicamente */
            text-align: center;
            line-height: 24px;
            color: white;
            white-space: nowrap;
            /* Impede quebra de linha no texto */
        }

        #progress-label {
            position: absolute;
            width: 100%;
            text-align: center;
            margin-top: 5px;
            color: #333;
            z-index: 1;
            bottom: -1px;
            color: white;
        }

        @media print {
            button {
                display: none;
            }
        }
    </style>
</head>

<body>
    <button id="back-button" onclick="goBack()">Voltar</button>
    <button onclick="window.print()">Imprimir</button>
    <h1 id="project-name"></h1>

    <div class="section">
        <h2>Detalhes do Projeto</h2>
        <table>
            <tbody id="project-details"></tbody>
        </table>
    </div>

    <div class="section">
        <h2>Tabela de Nutrientes</h2>
        <table>
            <thead>
                <tr>
                    <th>Nutriente</th>
                    <th>Fórmula</th>
                    <th>Percentual</th>
                    <th>Origem</th>
                </tr>
            </thead>
            <tbody id="nutrients-table"></tbody>
        </table>
    </div>

    <div class="section">
        <h2>Composição Total</h2>
        <div class="progress-bar-container">
            <div id="progress-bar" class="progress-bar">
                <div id="progress-completed" class="progress-completed"></div>
            </div>
            <div id="progress-label"></div>
        </div>
    </div>


    <div class="section">
        <h2>Preparo</h2>
        <table>
            <thead>
                <tr>
                    <th>Ordem</th>
                    <th>Matéria Prima</th>
                    <th>Percentual</th>
                    <th>Tempo de Agitação</th>
                    <th>Observação</th>
                </tr>
            </thead>
            <tbody id="preparo-table"></tbody>
        </table>
    </div>

    <div class="section">
        <h2>Coloração</h2>
        <table>
            <thead>
                <tr>
                    <th>Ordem</th>
                    <th>Matéria Prima</th>
                    <th>Percentual</th>
                    <th>Tempo de Agitação</th>
                    <th>Observação</th>
                </tr>
            </thead>
            <tbody id="coloracao-table"></tbody>
        </table>
    </div>

    <div class="section">
        <h2>Moagem</h2>
        <table>
            <thead>
                <tr>
                    <th>Ordem</th>
                    <th>Matéria Prima</th>
                    <th>Percentual</th>
                    <th>Tempo de Agitação</th>
                    <th>Observação</th>
                </tr>
            </thead>
            <tbody id="moagem-table"></tbody>
        </table>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src='/assets/js/config.js'></script>
    <script src='/assets/js/recursos.js'></script>

    <script>

        let param = getAllUrlParams()

        req_GET(opt.urlProjeto + `/detalhado/${param.id}`).then((result) => {
            if (result.success) {


                let data = result



                // Função para preencher os detalhes do projeto
                function preencherDetalhesDoProjeto(data) {
                    const detalhes = `
    <tr>
        <td colspan="1"><strong>ID:</strong> ${data.id}</td>
        <td colspan="5"><strong>Nome:</strong> ${data.nome}</td>
    </tr>
    <tr>
        <td colspan="2"><strong>Data de Início:</strong> ${new Date(data.data_inicio).toLocaleString()}</td>
        <td colspan="2"><strong>Data de Término:</strong> ${new Date(data.data_termino).toLocaleString()}</td>
        <td colspan="2"><strong>Status:</strong> ${data.status[0].status}</td>
    </tr>
    <tr>
        <td><strong>Aplicação:</strong> ${data.aplicacao}</td>
        <td><strong>Tipo:</strong> ${data.tipo}</td>
        <td><strong>Natureza Física:</strong> ${data.natureza_fisica}</td>
        <td><strong>pH:</strong> ${data.ph}</td>
        <td><strong>Densidade Real:</strong> ${data.densidade}</td>
        <td><strong>Densidade Estimada:</strong> ${data.dencidade_estimada}</td>
    </tr>
    <tr>
        <td colspan="6"><strong>Descrição:</strong> ${data.descricao}</td>
    </tr>
`;


                    document.getElementById('project-details').innerHTML = detalhes;
                    document.getElementById('project-name').innerText = data.nome;
                }

                // Função para preencher a tabela de nutrientes
                function preencherTabelaDeNutrientes(nutrientes) {
                    let tabela = '';
                    nutrientes.forEach(nutriente => {
                        let origem = nutriente.origem.map(o => `${o.mp} - ${o.percentual}%`).join('<br>');
                        tabela += `
                    <tr>
                        <td>${nutriente.nome}</td>
                        <td>${nutriente.formula}</td>
                        <td>${nutriente.percentual.toFixed(2)}%</td>
                        <td>${origem}</td>
                    </tr>
                `;
                    });
                    document.getElementById('nutrients-table').innerHTML = tabela;
                }

                // Função para preencher a barra de composição total
                function preencherBarraDeComposicao(total) {
                    const progressBar = document.getElementById('progress-bar');
                    const progressCompleted = document.getElementById('progress-completed');
                    const progressLabel = document.getElementById('progress-label');

                    // Usa o valor real do percentual concluído e restante
                    const percentualConcluido = total.percentual_concluido;
                    const percentualRestante = Math.max(0, 100 - percentualConcluido);

                    progressCompleted.style.width = `${percentualConcluido}%`;
                    progressLabel.innerText = `${percentualConcluido.toFixed(2)}% Concluído | ${percentualRestante.toFixed(2)}% Restante`;
                }



                // Função para preencher as etapas de Preparo, Coloração e Moagem
                function preencherEtapas(etapas, idTabela) {
                    let tabela = '';
                    if (etapas.length > 0) {
                        etapas.forEach((etapa, index) => {
                            tabela += `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${etapa.materia_prima}</td>
                            <td>${etapa.percentual.toFixed(2)}%</td>
                            <td>${etapa.tempo_agitacao}</td>
                            <td>${etapa.observacao || ''}</td>
                        </tr>
                    `;
                        });
                    } else {
                        tabela += '<tr><td colspan="5">Nenhum dado disponível</td></tr>';
                    }
                    document.getElementById(idTabela).innerHTML = tabela;
                }

                // Preenchendo os dados dinamicamente
                const projeto = data.data[0];
                preencherDetalhesDoProjeto(projeto);
                preencherTabelaDeNutrientes(projeto.nutrientes);
                preencherBarraDeComposicao(projeto);
                preencherEtapas(projeto.etapas[0].etapa_mp, 'preparo-table');
                preencherEtapas(projeto.etapas[1].etapa_mp, 'coloracao-table');
                preencherEtapas(projeto.etapas[2].etapa_mp, 'moagem-table');

            }
        })

        function goBack() {
            window.history.back();
        }
    </script>

</body>

</html>